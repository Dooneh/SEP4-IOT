name: Backend CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build and test with Maven
      run: mvn clean verify --file backend/iot-backend/pom.xml

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image from custom Dockerfile
      run: docker build -f Docker/Dockerfile -t ${{ secrets.DOCKER_USERNAME }}/springboot-backend:latest .

    - name: Push Docker image
      run: docker push ${{ secrets.DOCKER_USERNAME }}/springboot-backend:latest

    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

    - name: Delete existing container instance
      run: az container delete --name springboot-backend --resource-group VIA-SEP4 --yes

    - name: Recreate container instance with updated image
      run: |
        az container create \
          --name springboot-backend \
          --resource-group VIA-SEP4 \
          --image ${{ secrets.DOCKER_USERNAME }}/springboot-backend:latest \
          --cpu 1 \
          --memory 1.5 \
          --os-type Linux \
          --ip-address Public \
          --ports 23 \
          --restart-policy Never

